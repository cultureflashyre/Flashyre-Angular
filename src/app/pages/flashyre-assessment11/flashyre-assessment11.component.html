<!-- ### MODIFICATION START: Added alert component and wrapper ### -->

<!-- This alert will only display when the "NO_ATTEMPTS_REMAINING" error is caught -->
@if (showNoAttemptsAlert) {
  <app-alert-message
    [message]="alertMessage"
    [buttons]="showAlertButtons"
    >
  </app-alert-message>
}

@if (showErrorRedirectAlert) {
  <app-alert-message
    [message]="alertMessage"
    [buttons]="[]">
  </app-alert-message>
}

<!-- This wrapper hides the entire assessment UI while loading or if the above alert is active -->
@if (!isLoading && !showNoAttemptsAlert) {
  <div>
    <!-- ### MODIFICATION END ### -->
    <div class="flashyre-assessment11-container">
      @if (showSuccessPopup) {
        <div class="submission-success-popup">
          {{ successPopupMessage }}
        </div>
      }
      <!-- ### MODIFICATION END ### -->
      <!-- Popup Overlay -->
      @if (showWarningPopup) {
        <div class="popup-overlay">
          <assessment-warning-popup
            [sections]="sections"
            [userResponses]="userResponses"
            [codingSubmissions]="codingSubmissions"
            [sectionTimers]="sectionTimers"
            (endTestConfirmed)="terminateTest()"
            (closePopup)="handleCloseWarningPopup()"
            (questionNavigate)="handleQuestionNavigation($event)"
          ></assessment-warning-popup>
        </div>
      }
      <div id="main-container" class="flashyre-assessment11-main-container">
        <div id="header-container" class="flashyre-assessment11-header-container">
          <img
            id="Logo"
            alt="image"
            src="/assets/main-logo/logo%20-%20flashyre(1500px)-200h.png"
            class="flashyre-assessment11-logo"
            />
            <span id="timer" class="flashyre-assessment11-timer">{{ sectionTimer | timerFormat }}</span>
            <button
              id="end-test-button"
              type="button"
              (click)="showEndTestWarning()"
              class="flashyre-assessment11-end-test-button button"
              >
              <span id="end-test-text" class="flashyre-assessment11-end-test-text">
                End Test
              </span>
            </button>
          </div>
          <div
            id="assessment-questions-options-main-container"
            class="flashyre-assessment11-assessment-questions-options-main-container"
            >
            <div
              id="sections-questions-previous-next-containers"
              class="flashyre-assessment11-sections-questions-previous-next-containers"
              >
              <div
                data-thq="thq-dropdown"
                class="flashyre-assessment11-sections-dropdown list-item"
                >
                <div
                  data-thq="thq-dropdown-toggle"
                  class="flashyre-assessment11-dropdown-toggle1"
                  >
                  <span
                    id="sections-text"
                    class="flashyre-assessment11-sections-text"
                    >
                    {{ currentSection?.name || 'Sections' }}
                  </span>
                  <div
                    data-thq="thq-dropdown-arrow"
                    class="flashyre-assessment11-dropdown-arrow"
                    >
                    <svg
                      width="48"
                      height="48"
                      viewBox="0 0 48 48"
                      class="flashyre-assessment11-icon10"
                      >
                      <path
                        d="M36 18L24 30L12 18"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="4"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                      ></path>
                    </svg>
                  </div>
                </div>
                <ul data-thq="thq-dropdown-list" class="flashyre-assessment11-sections-dropdown-list">
                  @for (section of sections; track section) {
                    <li
                      (click)="isSectionAccessible(section) ? selectSection(section) : null"
                      [class.expired-section]="!isSectionAccessible(section)"
                      [style.cursor]="isSectionAccessible(section) ? 'pointer' : 'not-allowed'"
                      [style.opacity]="isSectionAccessible(section) ? '1' : '0.5'">
                      <div data-thq="thq-dropdown-toggle" class="flashyre-assessment11-dropdown-toggle2">
                        <span id="section-A-text" class="flashyre-assessment11-section-a-text">
                          {{ section.name }}
                          @if (!isSectionAccessible(section)) {
                            <span style="color: red; margin-left: 8px;">(Expired)</span>
                          }
                        </span>
                      </div>
                    </li>
                  }
                </ul>
              </div>
              @if (!isCodingSection) {
                <div
                  id="question-numbers-main-container"
                  class="flashyre-assessment11-question-numbers-main-container"
                  >
                  <svg
                    id="backward-arrow-icon"
                    width="32"
                    height="32"
                    viewBox="0 0 32 32"
                    class="flashyre-assessment11-backward-arrow-icon"
                    (click)="scrollLeft()"
                    >
                    <path
                      d="M10 16L20 6l1.4 1.4l-8.6 8.6l8.6 8.6L20 26z"
                      fill="currentColor"
                    ></path>
                  </svg>
                  <div
                    id="numbers-main-container"
                    class="flashyre-assessment11-numbers-main-container"
                    #numbersContainer
                    >
                    @for (question of currentSection?.questions; track question; let i = $index) {
                      <button
                        [id]="'question-number' + (i + 1) + '-button'"
                        type="button"
                        (click)="navigateToQuestion(i)"
              [ngClass]="{
                  'flashyre-assessment11-question-number1-button10': true,
                  'button': true,
                  'active': i === currentQuestionIndex
                }"
                        >
                        {{ i + 1 }}
                      </button>
                    }
                  </div>
                  <svg
                    id="forward-arrow-icon"
                    width="32"
                    height="32"
                    viewBox="0 0 32 32"
                    class="flashyre-assessment11-forward-arrow-icon"
                    (click)="scrollRight()"
                    >
                    <path
                      d="M22 16L12 26l-1.4-1.4l8.6-8.6l-8.6-8.6L12 6z"
                      fill="currentColor"
                    ></path>
                  </svg>
                </div>
              }
              <!-- MODIFICATION START: Previous/Next buttons now visible for all sections -->
              <div
                id="previous-next-button-main-container"
                class="flashyre-assessment11-previous-next-button-main-container1"
                >
                <!-- Previous button: visible on all but the very first section -->
                @if (currentSectionIndex > 0) {
                  <button
                    id="previous-button1"
                    type="button"
                    (click)="previousSection()"
                    class="flashyre-assessment11-previous-button1 button"
                    >
                    Previous
                  </button>
                }
                <!-- For MCQ sections -->
                @if (!isCodingSection) {
                  <!-- Next Question button -->
                  @if (!isLastQuestionInSection) {
                    <button
                      id="next-button"
                      type="button"
                      (click)="nextQuestion()"
                      class="flashyre-assessment11-next-button1 button"
                      >
                      Next
                    </button>
                  }
                  <!-- Next Section button -->
                  @if (isLastQuestionInSection && currentSectionIndex < totalSections - 1) {
                    <button
                      id="next-section-button"
                      type="button"
                      (click)="nextSection()"
                      class="flashyre-assessment11-next-section-button1 button"
                      >
                      Next Section
                    </button>
                  }
                }
                <!-- For Coding sections -->
                @if (isCodingSection) {
                  <!-- Next Section button for coding -->
                  @if (currentSectionIndex < totalSections - 1) {
                    <button
                      id="next-section-button-coding"
                      type="button"
                      (click)="nextSection()"
                      class="flashyre-assessment11-next-button1 button"
                      >
                      Next
                    </button>
                  }
                }
                <!-- Submit button: visible on the last question of the last section -->
                @if ((isLastQuestionInSection || isCodingSection) && currentSectionIndex === totalSections - 1) {
                  <button
                    id="submit-button"
                    type="button"
                    (click)="showEndTestWarning()"
                    class="flashyre-assessment11-submit-button1 button"
                    >
                    Submit
                  </button>
                }
              </div>
              <!-- MODIFICATION END -->
            </div>
            <div
              id="question-answer-container"
              class="flashyre-assessment11-question-answer-container"
              >
              <!-- Left side: Questions or Problem Description -->
              <div
                id="questions-container"
                class="flashyre-assessment11-questions-container"
                >
                @if (!isCodingSection) {
                  <span
                    id="question-num-text"
                    class="flashyre-assessment11-question-num-text"
                    >
                    Question {{ currentQuestionIndex + 1 }}
                  </span>
                  <div
                    id="question-container"
                    class="flashyre-assessment11-question-container"
                    >
                    <span
                      id="question-text"
                      class="flashyre-assessment11-question-text"
                      >
                      {{ currentQuestion.question || 'No question available' }}
                    </span>
                    @if (currentQuestion.question_image) {
                      <img
                        [src]="currentQuestion.question_image"
                        alt="question image"
                        class="flashyre-assessment11-image"
                        />
                    }
                  </div>
                  <!-- This button is redundant with top-level nav, consider removing -->
                  <button
                    id="previous-button"
                    type="button"
                    (click)="previousQuestion()"
                    class="flashyre-assessment11-previous-button2 button"
                    >
                    &lt;-
                  </button>
                }
                @if (isCodingSection) {
                  <app-problem-description [problem]="currentSection.problemData"></app-problem-description>
                }
              </div>
              <!-- This button is redundant with top-level nav, consider removing -->
              @if (!isCodingSection) {
                <button
                  id="next-button1"
                  type="button"
                  (click)="nextQuestion()"
                  class="flashyre-assessment11-next-button2 button"
                  >
                  -&gt;
                </button>
              }
              <!-- Right side: Answers or Code Editor + Test Results -->
              <div
                id="answers-container"
                class="flashyre-assessment11-answers-container"
                >
                @if (!isCodingSection) {
                  @if (hasQuestions) {
                    <div
                      id="select-an-option-container"
                      class="flashyre-assessment11-select-an-option-container"
                      >
                      <span
                        id="select-an-option-text"
                        class="flashyre-assessment11-select-an-option-text"
                        >
                        Select an option
                      </span>
                      <div
                        id="clear-response-container"
                        class="flashyre-assessment11-clear-response-container"
                        (click)="clearResponse(currentQuestion.question_id)"
                        >
                        <svg
                          id="eraser-icon"
                          width="24"
                          height="24"
                          viewBox="0 0 24 24"
                          class="flashyre-assessment11-eraser-icon"
                          >
                          <defs>
                            <clippath id="majesticonsEraserLine0">
                              <path d="M0 0h24v24H0z" fill="#fff"></path>
                            </clippath>
                          </defs>
                          <g fill="none">
                            <g clip-path="url(#majesticonsEraserLine0)">
                              <path
                                d="m11.607 6.535l-7.779 7.779a2 2 0 0 0 0 2.828l1.536 1.536a2 2 0 0 0 1.414.585h6.243M11.607 6.535l2.12-2.12a2 2 0 0 1 2.83 0l4.242 4.242a2 2 0 0 1 0 2.828l-2.121 2.122m-7.071-7.072l7.07 7.072m0 0l-5.656 5.656m0 0H20"
                                stroke="currentColor"
                                stroke-width="2"
                                stroke-linecap="round"
                                stroke-linejoin="round"
                              ></path>
                            </g>
                          </g>
                        </svg>
                        <span
                          id="clear-response-text"
                          class="flashyre-assessment11-clear-response-text"
                          >
                          Clear Response
                        </span>
                      </div>
                    </div>
                  }
                  <div
                    id="options-container"
                    class="flashyre-assessment11-options-container"
                    >
                    @for (option of currentOptions; track option; let i = $index) {
                      <div
                        [id]="['first', 'second', 'third', 'fourth'][i] + '-option-container'"
                        class="flashyre-assessment11-first-option-container"
                        >
                        <input
                          type="radio"
                          [id]="'radio' + (i + 1)"
                          name="radio"
                          [value]="option.key"
                          [(ngModel)]="userResponses[currentQuestion.question_id]"
                          (change)="onOptionSelected(currentQuestion.question_id, currentSection.section_id, option.key)"
                          class="flashyre-assessment11-radio1"
                          />
                          <label
                            [id]="['first', 'second', 'third', 'fourth'][i] + '-option-text-image-container'"
                            [for]="'radio' + (i + 1)"
                            class="flashyre-assessment11-first-option-text-image-container"
                            >
                            <span
                              [id]="['first', 'second', 'third', 'fourth'][i] + '-option-text'"
                              class="flashyre-assessment11-first-option-text"
                              >
                              {{ option.text || 'No option text' }}
                            </span>
                            @if (option.image) {
                              <img
                                [id]="['first', 'second', 'third', 'fourth'][i] + '-option-image'"
                                [src]="option.image"
                                alt="option image"
                                class="flashyre-assessment11-first-option-image"
                                />
                            }
                          </label>
                        </div>
                      }
                      <!-- Descriptive answer placeholder (not used unless question type changes) -->
                      @if (currentQuestion.question_type === 'descriptive') {
                        <div class="flashyre-assessment11-text-input-container">
                          <textarea
                            id="descriptive-answer"
                            class="flashyre-assessment11-description-type-answer textarea"
                            [(ngModel)]="userResponses[currentQuestion.question_id]"
                            placeholder="Enter your answer here"
                          ></textarea>
                        </div>
                      }
                    </div>
                  }
                  <!-- MODIFICATION START: Added inputs and outputs for code persistence -->
                  @if (isCodingSection) {
                    <div class="coding-section">
                      <app-code-editor
                        [problemId]="currentSection.coding_id_id"
                        [initialCode]="codingSolutions[currentSection.coding_id_id]?.code"
                        [initialLanguage]="codingSolutions[currentSection.coding_id_id]?.language"
                        (codeChange)="onCodeChange($event)"
                        (runCode)="onRunCode($event)"
                        (submitCode)="onSubmitCode($event)">
                      </app-code-editor>
                      @if (showTestResults) {
                        <app-test-results [results]="results"  (hideResults)="handleHideResults()"></app-test-results>
                      }
                    </div>
                  }
                  <!-- MODIFICATION END -->
                </div>
              </div>
            </div>
            <!-- This bottom navigation is redundant with the top one, consider removing for cleaner UI -->
            <div
              id="previous-next-button-main-container"
              class="flashyre-assessment11-previous-next-button-main-container2"
              >
              <!-- Content removed as it's now handled by the top navigation bar -->
            </div>
          </div>
        </div>
        <!-- ### MODIFICATION START: Closing tag for the wrapper ### -->
      </div>
    }
    <!-- ### MODIFICATION END ### -->