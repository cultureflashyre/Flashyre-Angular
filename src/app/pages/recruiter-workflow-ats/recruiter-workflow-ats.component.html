<div class="ats-layout-wrapper">
  
  <!-- NAVBAR INTEGRATION -->
  <div class="ats-navbar-container">
    <recruiter-workflow-navbar rootClassName="recruiter-workflow-navbarroot-class-name2">
      <!-- Standard Navbar Templates -->
      <ng-template #link1><span>Home</span></ng-template>
      <ng-template #link4><span>Requirements</span></ng-template>
      <ng-template #text1><span>Profile</span></ng-template>
      <ng-template #text2><span>Preference</span></ng-template>
      <ng-template #text3><span>Settings</span></ng-template>
      <ng-template #text7><span>Dashboard</span></ng-template>
      <ng-template #text9><span>Notifications</span></ng-template>
      <ng-template #text10><span>Jobs Posted</span></ng-template>
      <ng-template #text11><span>Preference</span></ng-template>
      <ng-template #text12><span>Settings</span></ng-template>
      <ng-template #text13><span>Logout</span></ng-template>
      <ng-template #text14><span>2</span></ng-template>
      <ng-template #text15><span>User Name</span></ng-template>
      <ng-template #text16><span>Company</span></ng-template>
      <ng-template #text31><span>Logout</span></ng-template>
      <ng-template #text32><span>Software Development<br />Location</span></ng-template>
      <ng-template #text1411><span>2</span></ng-template>
    </recruiter-workflow-navbar>
  </div>

  <!-- MAIN ATS CONTENT -->
  <div class="ats-main-content">
    <div class="ats-container">
      
      <!-- HEADER: Workflow Switcher & Add Candidate -->
      <div class="ats-header">
        <div class="header-left">
          <label class="workflow-label">Current Workflow:</label>
          
          <!-- WORKFLOW SWITCHER DROPDOWN -->
          <div class="custom-select-wrapper">
            <select 
              [(ngModel)]="selectedJobId" 
              (change)="onJobSwitch()" 
              class="workflow-switcher"
            >
              <option *ngFor="let job of availableJobs" [value]="job.id">
                <!-- Displays: Client Name - Job Role (Fallback to Description) -->
                {{ job.client_name }} - {{ job.role || job.job_role || (job.job_description | slice:0:30) }}
              </option>
            </select>
            <span class="dropdown-arrow">â–¼</span>
          </div>
        </div>
        
        <button class="add-candidate-btn" (click)="showAddCandidate = !showAddCandidate">
          <span>+</span> Add Candidate
        </button>
      </div>

      <!-- ADD CANDIDATE OVERLAY PANEL -->
      <div *ngIf="showAddCandidate" class="add-candidate-overlay">
        <h4>Add to Pipeline</h4>
        <input type="text" placeholder="Search Candidate Name..." 
               (input)="filterCandidates($event)" 
               class="search-input">
        
        <div class="candidate-results-list">
          <div *ngFor="let cand of filteredCandidates" 
               (click)="addCandidateToPipeline(cand)"
               class="candidate-result-item">
            {{ cand.first_name }} {{ cand.last_name }}
          </div>
        </div>
      </div>

      <!-- KANBAN BOARD -->
      <div class="pipeline-board" cdkDropListGroup>
        <div class="stage-column" *ngFor="let stage of stages">
          
          <!-- Stage Header -->
          <div class="stage-header">
            <span>{{ stage }}</span>
            <span class="stage-count">{{ pipelineData[stage]?.length || 0 }}</span>
          </div>

          <!-- Download Stage Report Button -->
          <button 
            class="icon-btn download-btn" 
            title="Download {{stage}} Report" 
            (click)="downloadStageReport(stage)"
          >
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
              <polyline points="7 10 12 15 17 10"></polyline>
              <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
          </button>

          <!-- Drop List Area -->
          <div class="card-list"
               cdkDropList
               [cdkDropListData]="pipelineData[stage]"
               (cdkDropListDropped)="drop($event, stage)">

            <!-- Candidate Card -->
            <div class="candidate-card" *ngFor="let app of pipelineData[stage]" cdkDrag>
              
              <!-- Card Header Row: Name + Action Icons -->
              <div class="card-header-row">
                <div class="card-title">{{ app.candidate_details.first_name }} {{ app.candidate_details.last_name }}</div>
                
                <div class="card-actions">
                  <!-- Eye Icon (View Details) -->
                  <button class="action-icon-btn view-btn" (click)="viewCandidateDetails(app.candidate_details)" title="View Details">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                      <circle cx="12" cy="12" r="3"></circle>
                    </svg>
                  </button>

                  <!-- File Icon (Open Resume) -->
                  <button 
                    class="action-icon-btn file-btn" 
                    [class.disabled]="!app.candidate_details.resume && !app.candidate_details.resume_url"
                    (click)="openResume(app.candidate_details.resume || app.candidate_details.resume_url)" 
                    title="Open Resume"
                  >
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                      <polyline points="14 2 14 8 20 8"></polyline>
                      <line x1="16" y1="13" x2="8" y2="13"></line>
                      <line x1="16" y1="17" x2="8" y2="17"></line>
                      <polyline points="10 9 9 9 8 9"></polyline>
                    </svg>
                  </button>
                </div>
              </div>

              <!-- Card Details -->
              <div class="card-info-row">
                <span class="card-label">Exp:</span> {{ app.candidate_details.total_experience_min }}y
              </div>
              <div class="card-info-row">
                <span class="card-label">CTC:</span> {{ app.candidate_details.current_ctc }}
              </div>
              
              <!-- Conditional Badges -->
              <div class="card-badges">
                <span *ngIf="app.interview_date" class="badge interview-badge">
                  ðŸ“… {{ app.interview_date | date:'shortDate' }}
                </span>
                <span *ngIf="stage === 'Rejected'" class="badge rejection-badge" title="{{app.rejection_reason}}">
                  Rejected
                </span>
              </div>
            </div>

          </div>
        </div>
      </div>

    </div>
  </div>
</div>


<!-- ========================================== -->
<!-- CANDIDATE DETAILS MODAL OVERLAY            -->
<!-- ========================================== -->
<div *ngIf="showCandidateDetails && selectedCandidate" class="details-modal-overlay">
  <div class="details-modal">
    
    <!-- Header with Name, File Icon, ID, Close Button -->
    <div class="details-modal-header">
      <div class="details-title-group">
        <div style="display: flex; align-items: center; gap: 10px;">
          <h2>{{ selectedCandidate.first_name }} {{ selectedCandidate.last_name }}</h2>
          
          <!-- File Icon in Modal Header -->
          <button 
            class="action-icon-btn file-btn modal-icon" 
            [class.disabled]="!selectedCandidate.resume && !selectedCandidate.resume_url"
            (click)="openResume(selectedCandidate.resume || selectedCandidate.resume_url)" 
            title="Open Resume"
          >
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
              <polyline points="14 2 14 8 20 8"></polyline>
              <line x1="16" y1="13" x2="8" y2="13"></line>
              <line x1="16" y1="17" x2="8" y2="17"></line>
              <polyline points="10 9 9 9 8 9"></polyline>
            </svg>
          </button>
        </div>
        <span class="details-id">ID: {{ selectedCandidate.id }}</span>
      </div>
      <button class="close-details-btn" (click)="closeCandidateDetails()">Ã—</button>
    </div>

    <!-- Modal Body -->
    <div class="details-modal-body">
      
      <!-- Section 1: Contact & Location -->
      <div class="details-section">
        <h4 class="section-title">Contact Information</h4>
        <div class="details-grid">
          <div class="detail-item">
            <label>Email</label>
            <span>{{ selectedCandidate.email }}</span>
          </div>
          <div class="detail-item">
            <label>Phone</label>
            <span>{{ selectedCandidate.phone_number }}</span>
          </div>
          <div class="detail-item">
            <label>Current Location</label>
            <span>{{ selectedCandidate.current_location }}</span>
          </div>
          <div class="detail-item">
            <label>Preferred Location</label>
            <span>{{ selectedCandidate.preferred_location }}</span>
          </div>
        </div>
      </div>

      <!-- Section 2: Professional Details -->
      <div class="details-section">
        <h4 class="section-title">Professional Overview</h4>
        <div class="details-grid">
          <div class="detail-item">
            <label>Total Experience</label>
            <span>{{ selectedCandidate.total_experience_min }} - {{ selectedCandidate.total_experience_max }} Years</span>
          </div>
          <div class="detail-item">
            <label>Relevant Experience</label>
            <span>{{ selectedCandidate.relevant_experience_min }} - {{ selectedCandidate.relevant_experience_max }} Years</span>
          </div>
          <div class="detail-item">
            <label>Current CTC</label>
            <span>{{ selectedCandidate.current_ctc }}</span>
          </div>
          <div class="detail-item">
            <label>Expected CTC</label>
            <span>{{ selectedCandidate.expected_ctc_min }} - {{ selectedCandidate.expected_ctc_max }} LPA</span>
          </div>
          <div class="detail-item">
            <label>Notice Period</label>
            <span>{{ selectedCandidate.notice_period }}</span>
          </div>
          <div class="detail-item">
            <label>Gender</label>
            <span>{{ selectedCandidate.gender }}</span>
          </div>
        </div>
      </div>

      <!-- Section 3: Skills & Work -->
      <div class="details-section">
        <h4 class="section-title">Skills & Experience</h4>
        <div class="detail-item full-width">
          <label>Work Experience</label>
          <p class="text-block">{{ selectedCandidate.work_experience }}</p>
        </div>
        <div class="detail-item full-width">
          <label>Skills</label>
          <div class="skills-container">
            <span class="skill-tag">{{ selectedCandidate.skills }}</span>
          </div>
        </div>
      </div>

    </div>

    <!-- Footer Area (Optional - Left empty as View Resume is in Header) -->
    <div class="details-modal-footer">
    </div>

  </div>
</div>

<!-- ============================================== -->
<!-- MODAL: SCHEDULE INTERVIEW                      -->
<!-- ============================================== -->
<div *ngIf="showInterviewModal" class="input-modal-overlay">
  <div class="input-modal">
    <div class="input-modal-header">
      <h3>Schedule Interview</h3>
      <button class="close-btn" (click)="closeModals()">Ã—</button>
    </div>
    <div class="input-modal-body">
      <label>Select Interview Date</label>
      <input type="date" [(ngModel)]="interviewDateInput" class="custom-input">
    </div>
    <div class="input-modal-footer">
      <button class="modal-btn cancel" (click)="closeModals()">Cancel</button>
      <button class="modal-btn confirm" (click)="submitInterview()">Confirm</button>
    </div>
  </div>
</div>

<!-- ============================================== -->
<!-- MODAL: REJECTION REASON                        -->
<!-- ============================================== -->
<div *ngIf="showRejectionModal" class="input-modal-overlay">
  <div class="input-modal">
    <div class="input-modal-header">
      <h3>Reason for Rejection</h3>
      <button class="close-btn" (click)="closeModals()">Ã—</button>
    </div>
    <div class="input-modal-body">
      <label>Please specify why this candidate is being rejected:</label>
      <textarea [(ngModel)]="rejectionReasonInput" class="custom-textarea" placeholder="e.g. Skills mismatch, high CTC expectation..."></textarea>
    </div>
    <div class="input-modal-footer">
      <button class="modal-btn cancel" (click)="closeModals()">Cancel</button>
      <button class="modal-btn delete" (click)="submitRejection()">Reject Candidate</button>
    </div>
  </div>
</div>

<!-- ============================================== -->
<!-- GENERIC ALERT MESSAGE                          -->
<!-- ============================================== -->
<app-alert-message
  *ngIf="showAlert"
  [message]="alertMessage"
  [buttons]="alertButtons"
  (buttonClicked)="onAlertAction($event)"
  (close)="onAlertClose()"
></app-alert-message>