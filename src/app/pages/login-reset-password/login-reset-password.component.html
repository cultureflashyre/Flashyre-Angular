<div class="container">
  <div class="card">
    <h2 class="card-title">Reset Your Password</h2>

    <!-- Error Message -->
    <div *ngIf="error" class="alert alert-danger">{{ error }}</div>

    <!-- Success Message (Before OTP Verification) -->
    <div *ngIf="message && !isOTPVerified" class="alert alert-success">{{ message }}</div>

    <!-- Form -->
    <form (ngSubmit)="handleSubmit()" aria-labelledby="reset-password-title">
      <!-- Email Field -->
      <div class="form-group">
        <label for="email" class="form-label">Email Address</label>
        <input
          type="email"
          class="form-control"
          id="email"
          [ngModel]="email || 'Awaiting email...'"
          name="email"
          readonly
          aria-describedby="emailHelp"
          [disabled]="!email"
        />
        <span class="form-hint">
          {{ email ? 'OTP sent to this email.' : 'Please request an OTP from the Forgot Password page.' }}
        </span>
      </div>

      <!-- OTP Field (Shown before OTP verification) -->
      <div class="form-group" *ngIf="!isOTPVerified && email">
        <label for="otp" class="form-label">Enter OTP</label>
        <input
          type="text"
          class="form-control"
          id="otp"
          [(ngModel)]="otp"
          name="otp"
          placeholder="6-digit OTP"
          required
          aria-required="true"
          [disabled]="loading"
          maxlength="6"
          pattern="[0-9]{6}"
        />
        <!-- Countdown Timer -->
        <div class="countdown" aria-live="polite">
          <span *ngIf="countdown > 0">Time remaining: {{ countdown }} seconds</span>
          <span *ngIf="countdown === 0">OTP expired. Please resend OTP.</span>
        </div>
      </div>

      <!-- Resend OTP Link (Shown when countdown reaches 0) -->
      <div class="form-group resend-container" *ngIf="!isOTPVerified && email && countdown === 0">
        <a
          href="javascript:void(0)"
          class="resend-link"
          [class.disabled]="loading"
          (click)="resendOTP()"
          aria-label="Resend OTP"
          tabindex="0"
        >
          <span *ngIf="loading" class="spinner"></span>
          <span *ngIf="!loading">Resend</span>
        </a>
      </div>

      <!-- Password Field (Shown after OTP verification) -->
      <div class="form-group" *ngIf="isOTPVerified && email">
        <label for="password" class="form-label">New Password</label>
        <div class="input-wrapper">
          <input
            [type]="showPassword ? 'text' : 'password'"
            class="form-control"
            id="password"
            [(ngModel)]="password"
            name="password"
            placeholder="Enter new password"
            required
            aria-required="true"
            [disabled]="loading"
          />
          <span
            class="toggle-password"
            (click)="togglePasswordVisibility()"
            [attr.aria-label]="showPassword ? 'Hide password' : 'Show password'"
            role="button"
            tabindex="0"
            (keydown)="onKeydown($event, 'password')"
          >
            <i [ngClass]="showPassword ? 'fas fa-eye-slash' : 'fas fa-eye'"></i>
          </span>
        </div>
      </div>

      <!-- Confirm Password Field (Shown after OTP verification) -->
      <div class="form-group" *ngIf="isOTPVerified && email">
        <label for="confirmPassword" class="form-label">Confirm Password</label>
        <div class="input-wrapper">
          <input
            [type]="showConfirmPassword ? 'text' : 'password'"
            class="form-control"
            id="confirmPassword"
            [(ngModel)]="confirmPassword"
            name="confirmPassword"
            placeholder="Confirm new password"
            required
            aria-required="true"
            [disabled]="loading"
          />
          <span
            class="toggle-password"
            (click)="toggleConfirmPasswordVisibility()"
            [attr.aria-label]="showConfirmPassword ? 'Hide confirm password' : 'Show confirm password'"
            role="button"
            tabindex="0"
            (keydown)="onKeydown($event, 'confirmPassword')"
          >
            <i [ngClass]="showConfirmPassword ? 'fas fa-eye-slash' : 'fas fa-eye'"></i>
          </span>
        </div>
      </div>

      <!-- Submit Button -->
      <button
        type="submit"
        class="btn btn-primary"
        [disabled]="loading || !email || (isOTPVerified && (!password || !confirmPassword))"
        [attr.aria-label]="getButtonAriaLabel()"
      >
        <span *ngIf="loading" class="spinner"></span>
        <span *ngIf="!loading">{{ getButtonText() }}</span>
      </button>
    </form>

    <!-- Navigation Link -->
    <div class="nav-link">
      <a href="/login-forgot-password">Back to Forgot Password</a>
    </div>

    <!-- Success Message (After Password Reset) -->
    <div *ngIf="isOTPVerified && message" class="alert alert-success">{{ message }}</div>
  </div>
</div>