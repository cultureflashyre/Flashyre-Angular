@if (showRoleMismatchAlert) {
  <app-alert-message
    [message]="roleMismatchMessage"
    [buttons]="roleMismatchButtons"
    (buttonClicked)="handleMismatchAlertAction($event)"
    (close)="closeMismatchAlert()"
  ></app-alert-message>
}

@if (showRoleSelection) {
  <div class="popup-overlay">
    <div class="popup-content role-selection-popup">
      <h3>Who is signing up?</h3>
      <div class="role-buttons">
        <button class="role-button" (click)="selectUserType('candidate')">Candidate</button>
        <button class="role-button" (click)="selectUserType('recruiter')">Recruiter</button>
        <button class="role-button" (click)="selectUserType('admin')">Admin</button>
      </div>
      <div class="popup-actions">
        <button class="popup-button cancel" (click)="cancelRoleSelection()">Cancel</button>
      </div>
    </div>
  </div>
}

<!-- Phone Number Popup Overlay -->
@if (showPhonePopup) {
  <div class="popup-overlay">
    <div class="popup-content">
      <h3>Complete Your Signup</h3>
      <p class="popup-note">
        Welcome, {{ googleUserData?.first_name }}! To finish creating your account, please provide your 10-digit phone number.
      </p>
      <div class="popup-input-group">
        <label for="phone-number-input">Phone Number</label>
        <input
          id="phone-number-input"
          type="tel"
          class="popup-input"
          placeholder="Enter 10-digit phone number"
          formControlName="popup_phone_number"
          maxlength="10"
          (input)="sanitizePhoneNumber($event, 'popup_phone_number')" 
          />
          @if (signupForm.get('popup_phone_number').invalid && signupForm.get('popup_phone_number').touched) {
            <div class="error-text">
              @if (signupForm.get('popup_phone_number').errors?.required) {
                <span>Phone number is required.</span>
              }
              @if (signupForm.get('popup_phone_number').errors?.pattern) {
                <span>Phone number must be exactly 10 digits.</span>
              }
            </div>
          }
              @if (signupForm.get('popup_phone_number').errors?.phoneExists) {
                    <div class="error-text">
                      Phone number already exists.
                    </div>
                  }
      </div>
      <div class="popup-actions">
        <button class="popup-button cancel" (click)="cancelGoogleSignup()">Cancel</button>
        <button class="popup-button generate" (click)="onPhoneSubmit()" [disabled]="signupForm.get('popup_phone_number').invalid || isSubmittingPhone">
          @if (!isSubmittingPhone) {
            <span>Create Account</span>
          }
          @if (isSubmittingPhone) {
            <span class="button-spinner-container">
              <span class="tab-spinner"></span> Creating...
            </span>
          }
        </button>
      </div>
      @if (popupErrorMessage) {
        <div class="error-text" style="text-align: center; margin-top: 10px;">{{ popupErrorMessage }}</div>
      }
    </div>
  </div>
}
  <!-- End of Popup -->

@if (!showRoleSelection) {
  <div id="signup-page" class="signup-candidate1-container" [ngClass]="rootClassName">
    <div id="signup-container" class="signup-candidate1-signup-container">
      <h2 id="heading" class="signup-candidate1-welcome-to-flashyre">
        <span>Welcome to Flashyre</span>
      </h2>

      <!-- ADD: Contextual Header -->
      <div class="signup-context-header">
        <span class="context-text">Signing up as {{ userType | titlecase }}</span>
        <button type="button" class="change-button" (click)="changeUserType()">Change</button>
      </div>

      <form [formGroup]="signupForm" (ngSubmit)="onSubmit()">
        <div id="details" class="signup-candidate1-details-container">
          <!-- First Name -->
          <div id="first-name-container" class="signup-candidate1-first-name-container">
            <span class="signup-candidate1-first-name-text">First Name</span>
            <input
              type="text"
              id="signup-first-name-input"
              placeholder="Enter First Name"
              formControlName="first_name"
              class="signup-candidate1-first-name-input input"
              />
              @if (signupForm.get('first_name').invalid && signupForm.get('first_name').touched) {
                <div class="error-text">
                  @if (signupForm.get('first_name').errors?.required) {
                    <span>First name is required.</span>
                  }
                  @if (signupForm.get('first_name').errors?.pattern) {
                    <span>Only letters and spaces are allowed.</span>
                  }
                  @if (signupForm.get('first_name').errors?.minlength) {
                    <span>First name must be at least 3 characters long.</span>
                  }
                  @if (signupForm.get('first_name').errors?.maxlength) {
                    <span>First name cannot exceed 10 characters.</span>
                  }
                </div>
              }
            </div>

            <!-- Last Name -->
            <div id="last-name-container" class="signup-candidate1-last-name-container1">
              <span class="signup-candidate1-last-name-text1">Last Name</span>
              <input
                type="text"
                id="signup-last-name-input"
                placeholder="Enter Last Name"
                formControlName="last_name"
                class="signup-candidate1-last-name-input1 input"
                />
                @if (signupForm.get('last_name').invalid && signupForm.get('last_name').touched) {
                  <div class="error-text">
                    @if (signupForm.get('last_name').errors?.required) {
                      <span>Last name is required.</span>
                    }
                    @if (signupForm.get('last_name').errors?.pattern) {
                      <span>Only letters and spaces are allowed.</span>
                    }
                    @if (signupForm.get('last_name').errors?.minlength) {
                      <span>Last name must be at least 3 characters long.</span>
                    }
                    @if (signupForm.get('last_name').errors?.maxlength) {
                      <span>Last name cannot exceed 10 characters.</span>
                    }
                  </div>
                }
              </div>

              <!-- Phone Number -->
              <div id="phone-container" class="signup-candidate1-last-name-container2">
                <span class="signup-candidate1-last-name-text2">Phone Number</span>
                <input
                  type="text"
                  id="signup-phone-number-input"
                  placeholder="Enter Phone Number"
                  formControlName="phone_number"
                  class="signup-candidate1-last-name-input2 input"
                  maxlength="10"
                  (input)="sanitizePhoneNumber($event, 'phone_number')"
                  />
                  @if (signupForm.get('phone_number').invalid && signupForm.get('phone_number').touched) {
                    <div class="error-text">
                      @if (signupForm.get('phone_number').errors?.required) {
                        <span>Phone number is required.</span>
                      }
                      @if (signupForm.get('phone_number').errors?.pattern) {
                        <span>Phone number must be exactly 10 digits.</span>
                      }
                    </div>
                  }
                  @if (signupForm.get('phone_number').errors?.phoneExists) {
                    <div class="error-text">
                      Phone number already exists.
                    </div>
                  }
                </div>

                <!-- Email -->
                <div id="email-container" class="signup-candidate1-email-container">
                  <span class="signup-candidate1-email-text">Email Id</span>
                  <input
                    type="email"
                    id="signup-email-input"
                    placeholder="Enter Email Id"
                    formControlName="email"
                    class="signup-candidate1-email-input input"
                    />
                    @if (signupForm.get('email').invalid && signupForm.get('email').touched) {
                      <div class="error-text">
                        @if (signupForm.get('email').errors?.required) {
                          <span>Email is required.</span>
                        }
                        @if (signupForm.get('email').errors?.email) {
                          <span>Please enter a valid email.</span>
                        }
                      </div>
                    }
                    @if (signupForm.get('email').errors?.emailExists) {
                      <div class="error-text">
                        Email already exists.
                      </div>
                    }
                  </div>

                  <!-- Password -->
                  <div id="password-container" class="signup-candidate1-password-container1">
                    <div class="signup-candidate1-password1">
                      <span class="signup-candidate1-password-text1">Password</span>
                      <span
                        class="signup-candidate1-show-text1 button"
                        (click)="togglePasswordVisibility()"
                        >
                        {{ passwordType === 'password' ? 'Show' : 'Hide' }}
                      </span>
                      <input
                        [type]="passwordType"
                        id="signup-password-input"
                        placeholder="Enter Password"
                        formControlName="password"
                        class="signup-candidate1-password-input1 input"
                        maxlength="15"
                        />

                      </div>
                      @if (signupForm.get('password').invalid && signupForm.get('password').dirty) {
                        <div class="error-text">
                          @if (signupForm.get('password').errors?.required) {
                            <span>Password is required.</span>
                          }
                          @if (signupForm.get('password').errors?.minlength) {
                            <span>Password must be at least 8 characters.</span>
                          }
                          @if (signupForm.get('password').errors?.maxlength) {
                            <span>Password cannot exceed 15 characters.</span>
                          }
                          @if (signupForm.get('password').errors?.uppercase) {
                            <span>Password must include at least one uppercase letter.</span>
                          }
                          @if (signupForm.get('password').errors?.lowercase) {
                            <span>Password must include at least one lowercase letter.</span>
                          }
                          @if (signupForm.get('password').errors?.number) {
                            <span>Password must include at least one number.</span>
                          }
                          @if (signupForm.get('password').errors?.specialChar) {
                            <span>Password must include at least one special character.</span>
                          }
                          @if (signupForm.get('password').errors?.alphabet) {
                            <span>Password must include at least one alphabet.</span>
                          }
                        </div>
                      }
                    </div>

                    <!-- Confirm Password -->
                    <div id="password-container" class="signup-candidate1-password-container2">
                      <div class="signup-candidate1-password2">
                        <span class="signup-candidate1-password-text2">Confirm Password</span>
                        <span
                          class="signup-candidate1-show-text2 button"
                          (click)="toggleConfirmPasswordVisibility()"
                          >
                          {{ confirmPasswordType === 'password' ? 'Show' : 'Hide' }}
                        </span>
                        <input
                          [type]="confirmPasswordType"
                          id="signup-confirm-password-input"
                          placeholder="Confirm Password"
                          formControlName="confirm_password"
                          class="signup-candidate1-password-input2 input"
                          maxlength="15"
                          />

                        </div>
                        @if (signupForm.hasError('mismatch') && signupForm.get('confirm_password').dirty) {
                          <div class="error-text">
                            Passwords do not match.
                          </div>
                        }
                      </div>

                      <!-- Signup Button and Error Message -->
                      <div class="signup-candidate1-signup-and-signin-container">
                        <button
                          id="signup-button"
                          type="submit"
                          [disabled]="signupForm.invalid"
                          class="signup-candidate1-signup-button button"
                          >
                          Sign Up
                        </button>

                        <div class="google-signin-container">
                          <div class="separator">OR</div>
                          <asl-google-signin-button
                            class="google-button-wrapper"
                            type='standard'
                            size='large'
                            theme='outline'
                            shape='rectangular'
                            text='signup_with'
                            width='320px'
                          ></asl-google-signin-button>
                        </div>
                        <!-- ADD GOOGLE SIGNUP SECTION -->

                        <!-- END GOOGLE SIGNUP SECTION -->

                        @if (errorMessage) {
                          <div class="signup-candidate1-error-signup-container">
                            <span class="signup-candidate1-error-message-signup">{{ errorMessage }}</span>
                          </div>
                        }

                        <!-- Add this after the error message div -->
                        @if (successMessage) {
                          <div class="signup-candidate1-success-signup-container">
                            <span class="signup-candidate1-success-message-signup">{{ successMessage }}</span>
                          </div>
                        }

                        <!-- Sign In Link -->
                        <div class="signup-candidate1-signin-container">
                          <span class="signup-candidate1-already-have-an-account-text">
                            Already have an account?
                          </span>
                          <span class="signup-candidate1-signin-text button" routerLink="/login">
                            Sign In
                          </span>
                        </div>
                      </div>
                    </div>
                  </form>
                </div>
              </div>
}              