{"ast":null,"code":"import { __awaiter, __decorate } from \"tslib\";\nimport { Component } from '@angular/core';\nlet FlashyreAssessment1 = class FlashyreAssessment1 {\n  constructor(title, meta, assessmentService, videoRecorder, proctoringService, router) {\n    this.title = title;\n    this.meta = meta;\n    this.assessmentService = assessmentService;\n    this.videoRecorder = videoRecorder;\n    this.proctoringService = proctoringService;\n    this.router = router;\n    this.assessmentData = {};\n    this.sections = [];\n    this.currentQuestions = [];\n    this.currentQuestionIndex = 0;\n    this.userId = 1;\n    this.isLastQuestionInSection = false;\n    this.isLastSection = false;\n    this.selectedAnswers = {};\n    this.questionStates = {};\n    this.title.setTitle('Flashyre-Assessment1 - Flashyre');\n    this.meta.addTags([{\n      property: 'og:title',\n      content: 'Flashyre-Assessment1 - Flashyre'\n    }, {\n      property: 'og:image',\n      content: 'https://aheioqhobo.cloudimg.io/v7/_playground-bucket-v2.teleporthq.io_/8203932d-6f2d-4493-a7b2-7000ee521aa2/9aea8e9c-27ce-4011-a345-94a92ae2dbf8?org_if_sml=1&force_format=original'\n    }]);\n  }\n\n  ngOnInit() {\n    return __awaiter(this, void 0, void 0, function* () {\n      const assessmentId = 1; // Replace with actual assessment ID\n\n      this.fetchAssessmentData(assessmentId);\n\n      try {\n        yield this.videoRecorder.startRecording();\n        this.proctoringService.startMonitoring();\n      } catch (error) {\n        console.error('Failed to start assessment:', error);\n      }\n\n      this.checkLastQuestionAndSection();\n    });\n  }\n\n  ngOnDestroy() {\n    if (this.timerSubscription) {\n      this.timerSubscription.unsubscribe();\n    }\n\n    clearInterval(this.timerInterval); // <-- Clear interval on destroy\n  }\n\n  fetchAssessmentData(assessmentId) {\n    this.assessmentService.getAssessmentData(assessmentId).subscribe(data => {\n      this.assessmentData = data;\n      this.sections = Object.keys(data.sections).map(sectionName => Object.assign({\n        name: sectionName\n      }, data.sections[sectionName]));\n      this.timer = data.total_assessment_duration * 60; // Convert minutes to seconds\n\n      this.assessmentService.updateTimer(this.timer);\n      console.log('timer data in seconds: ', this.timer);\n      this.startTimer();\n      this.selectSection(this.sections[0]);\n      this.startTime = new Date();\n    });\n  }\n\n  startTimer() {\n    this.timerSubscription = this.assessmentService.timer$.subscribe(time => {\n      this.timer = time;\n      console.log('timer data in startTimer(): ', this.timer);\n\n      if (this.timer <= 0) {\n        this.terminateTest();\n      }\n    });\n    this.decrementTimer();\n  }\n\n  decrementTimer() {\n    this.timerInterval = setInterval(() => {\n      // <-- Use a class property\n      if (this.timer > 0) {\n        this.assessmentService.updateTimer(this.timer - 1);\n      } else {\n        clearInterval(this.timerInterval); // <-- Clean up when done\n      }\n    }, 1000);\n  }\n\n  checkLastQuestionAndSection() {\n    this.isLastQuestionInSection = this.currentQuestionIndex === this.currentQuestions.length - 1;\n    this.isLastSection = this.sections.indexOf(this.currentSection) === this.sections.length - 1;\n  }\n\n  navigateToNextSection() {\n    const nextSectionIndex = this.sections.indexOf(this.currentSection) + 1;\n\n    if (nextSectionIndex < this.sections.length) {\n      this.selectSection(this.sections[nextSectionIndex]);\n    }\n  }\n\n  submitAssessment() {\n    const responses = this.prepareSubmissionData();\n    this.assessmentService.submitAssessment(responses).subscribe({\n      next: response => {\n        console.log('Assessment submitted successfully:', response); // Navigate to completion page\n      },\n      error: error => {\n        console.error('Assessment submission failed:', error); // Handle error\n      }\n    });\n  }\n\n  selectSection(section) {\n    this.currentSection = section;\n    this.currentQuestions = section.questions;\n    this.currentQuestionIndex = 0;\n  }\n\n  getOptions(question) {\n    const options = Object.keys(question.options).map(key => ({\n      key,\n      value: question.options[key]\n    }));\n    return question.option_type === 2 ? options.slice(0, 2) : options.slice(0, 4);\n  }\n\n  markQuestionAsVisited(index) {\n    if (!this.questionStates[index]) {\n      this.questionStates[index] = 'visited';\n    }\n  }\n\n  markQuestionAsAnswered(index) {\n    if (this.questionStates[index] === 'visited') {\n      this.questionStates[index] = 'answered';\n    }\n  }\n\n  navigateToQuestion(index) {\n    if (index >= 0 && index < this.currentQuestions.length) {\n      this.currentQuestionIndex = index;\n      this.markQuestionAsVisited(index);\n    }\n  }\n\n  selectOption(questionId, sectionId, answer) {\n    this.selectedAnswers[questionId] = {\n      answer: answer,\n      section_id: sectionId\n    };\n    this.markQuestionAsAnswered(this.currentQuestionIndex);\n  } // New method to clear the selected answer\n\n\n  clearResponse(questionId) {\n    delete this.selectedAnswers[questionId];\n  }\n\n  terminateTest() {\n    return __awaiter(this, void 0, void 0, function* () {\n      try {\n        // 1. Stop recording\n        this.videoRecorder.stopRecording(); // 2. Stop proctoring\n\n        this.proctoringService.stopMonitoring();\n        this.videoPath = yield this.videoRecorder.getVideoPath(); // 3. Submit responses\n\n        const responses = this.prepareSubmissionData();\n        this.assessmentService.submitAssessment(responses).subscribe({\n          next: response => {\n            console.log('Assessment submitted successfully:', response);\n            this.router.navigate(['/assessment-complete']);\n          },\n          error: error => {\n            console.error('Assessment submission failed:', error);\n            this.router.navigate(['/assessment-error']);\n          }\n        });\n      } catch (error) {\n        console.error('Termination failed:', error);\n        this.router.navigate(['/assessment-error']);\n      }\n    });\n  }\n\n  prepareSubmissionData() {\n    return {\n      assessmentId: this.assessmentData.assessment_id,\n      userId: this.userId,\n      responses: Object.keys(this.selectedAnswers).map(questionId => ({\n        questionId: +questionId,\n        sectionId: this.selectedAnswers[+questionId].section_id,\n        answer: this.selectedAnswers[+questionId].answer\n      })),\n      startTime: this.startTime,\n      endTime: new Date().toISOString(),\n      submissionType: 'manual',\n      videoPath: this.videoPath // Path to the recorded video\n\n    };\n  }\n\n  previousQuestion() {\n    if (this.currentQuestionIndex > 0) {\n      this.currentQuestionIndex--;\n    }\n  }\n\n  nextQuestion() {\n    if (this.currentQuestionIndex < this.currentQuestions.length - 1) {\n      this.currentQuestionIndex++;\n    }\n  }\n\n};\nFlashyreAssessment1 = __decorate([Component({\n  selector: 'flashyre-assessment1',\n  templateUrl: 'flashyre-assessment1.component.html',\n  styleUrls: ['flashyre-assessment1.component.css']\n})], FlashyreAssessment1);\nexport { FlashyreAssessment1 };","map":null,"metadata":{},"sourceType":"module"}